<!DOCTYPE html>
<html lang="ko">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>ì‹¤ì‹œê°„ ì±„íŒ… ì•±</title>
   <!-- Socket.IO í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
   <script src="/socket.io/socket.io.js"></script>
   <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">ì„¸ë¥œì¤‘ ì±„íŒ…ë°©</div>
        <div class="online-users-header" id="users-toggle">
            <div>ì˜¨ë¼ì¸: <span id="user-count">0</span>ëª…</div>
            <div class="online-users-toggle">
                ì‚¬ìš©ìž ëª©ë¡ <span class="toggle-icon">â–¼</span>
            </div>
        </div>
        <div class="online-users-panel" id="users-panel">
            <div class="online-users-list" id="users-list">
                <!-- ì‚¬ìš©ìž ëª©ë¡ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>
        <div class="messages" id="messages">
            <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
        <div class="chat-input">
            <div class="typing-indicator" id="typing-indicator" style="display: none;"></div>
            <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ìž…ë ¥í•˜ì„¸ìš”...">
            <button id="send-button">â†µ</button>
        </div>
    </div>
    
    <div id="username-modal">
        <div class="modal-content">
            <h2>ì±„íŒ…ì— ì°¸ì—¬í•˜ê¸°</h2>
            <input type="text" id="username-input" placeholder="ì‚¬ìš©ìž ì´ë¦„ì„ ìž…ë ¥í•˜ì„¸ìš”">
            <button id="username-submit">ì‹œìž‘í•˜ê¸°</button>
        </div>
    </div>
  <script>
        // ì‚¬ìš©ìž ì •ë³´
        let username = '';
        let userColor = '';
        let isAdmin = false;
        let isSuspended = false;
        let suspendedUntil = null;
        let suspendTimer = null;
        
        // ê´€ë¦¬ìž ì´ë¦„ ì„¤ì •
        const ADMIN_USERNAME = 'ì•³ìƒˆì´í•˜ì¤€';
        
        // ì˜¨ë¼ì¸ ì‚¬ìš©ìž ëª©ë¡ ì €ìž¥
        const onlineUsers = {};
        
        // Socket.IO ì—°ê²°
        const socket = io();
        
        // ëžœë¤ ìƒ‰ìƒ ìƒì„± í•¨ìˆ˜
        function getRandomColor() {
            const colors = [
                '#FF6633', '#FFB399', '#FF33FF', '#FFFF99', '#00B3E6', 
                '#E6B333', '#3366E6', '#999966', '#99FF99', '#B34D4D',
                '#80B300', '#809900', '#E6B3B3', '#6680B3', '#66991A'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // ì‹œê°„ í¬ë§· í•¨ìˆ˜
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
        function addMessage(message, isUser = false, isSystem = false, isAdmin = false, isKick = false) {
            const messagesContainer = document.getElementById('messages');
            const messageElement = document.createElement('div');
            
            messageElement.classList.add('message');
            
            if (isKick) {
                messageElement.classList.add('kick-message');
                messageElement.innerHTML = message;
            } else if (isAdmin) {
                messageElement.classList.add('admin-message');
                messageElement.innerHTML = message;
            } else if (isSystem) {
                messageElement.classList.add('system-message');
                messageElement.innerHTML = message;
            } else if (isUser) {
                messageElement.classList.add('user-message');
                messageElement.innerHTML = `
                    ${message}
                    <div class="message-info">${formatTime(new Date())}</div>
                `;
            } else {
                messageElement.classList.add('other-message');
                messageElement.innerHTML = message;
                if (!message.includes('class="message-info"')) {
                    messageElement.innerHTML += `<div class="message-info">${formatTime(new Date())}</div>`;
                }
            }
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (message) {
                // ì •ì§€ ìƒíƒœ í™•ì¸
                if (isSuspended) {
                    const remainingTime = Math.ceil((suspendedUntil - Date.now()) / 1000);
                    addMessage(`ì±„íŒ…ì´ ì¼ì‹œ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ${remainingTime}ì´ˆ í›„ì— ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.`, false, true);
                    return;
                }
                
                // ê´€ë¦¬ìž ëª…ë ¹ì–´ ì²˜ë¦¬
                if (isAdmin) {
                    // ì •ì§€ ëª…ë ¹ì–´
                    if (message.startsWith('/ì •ì§€ ')) {
                        const parts = message.split(' ');
                        if (parts.length >= 3) {
                            const targetUsername = parts[1];
                            const duration = parseInt(parts[2]);
                            
                            if (!isNaN(duration)) {
                                socket.emit('suspendUser', {
                                    targetUsername: targetUsername,
                                    duration: duration
                                });
                                messageInput.value = '';
                                return;
                            }
                        }
                    }
                    
                    // ê°•í‡´ ëª…ë ¹ì–´
                    if (message.startsWith('/ê°•í‡´ ')) {
                        const parts = message.split(' ');
                        if (parts.length >= 2) {
                            const targetUsername = parts[1];
                            
                            socket.emit('kickUser', {
                                targetUsername: targetUsername
                            });
                            messageInput.value = '';
                            return;
                        }
                    }
                }
                
                // ë©˜ì…˜ í™•ì¸ ë° ì²˜ë¦¬
                const mentionRegex = /@(\S+)/g;
                let processedMessage = message;
                const mentions = [];
                
                let match;
                while ((match = mentionRegex.exec(message)) !== null) {
                    const mentionedUser = match[1];
                    mentions.push(mentionedUser);
                    processedMessage = processedMessage.replace(
                        `@${mentionedUser}`, 
                        `<span class="mention">@${mentionedUser}</span>`
                    );
                }
                
                // ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡
                socket.emit('sendMessage', {
                    text: processedMessage,
                    mentions: mentions,
                    isHtml: mentions.length > 0
                });
                
                // ìž…ë ¥ì°½ ì´ˆê¸°í™”
                messageInput.value = '';
            }
        }
        
        // ë©˜ì…˜ ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showMentionAlert(username) {
            const alertElement = document.createElement('div');
            alertElement.classList.add('mention-alert');
            alertElement.textContent = `${username}ë‹˜ì´ ë©˜ì…˜í•˜ì…¨ìŠµë‹ˆë‹¤`;
            document.body.appendChild(alertElement);
            
            setTimeout(() => {
                alertElement.remove();
            }, 4000);
        }
        
        // ê°•í‡´ ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showKickAlert(adminUsername) {
            const alertElement = document.createElement('div');
            alertElement.classList.add('kick-alert');
            alertElement.innerHTML = `
                <div>ê´€ë¦¬ìž ${adminUsername}ë‹˜ì— ì˜í•´ ê°•í‡´ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
                <div style="margin-top: 10px; font-size: 14px;">3ì´ˆ í›„ ì—°ê²°ì´ ì¢…ë£Œë©ë‹ˆë‹¤.</div>
            `;
            document.body.appendChild(alertElement);
            
            setTimeout(() => {
                alertElement.remove();
            }, 3000);
        }
        
        // ì˜¨ë¼ì¸ ì‚¬ìš©ìž ëª©ë¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateOnlineUsersList() {
            const usersListElement = document.getElementById('users-list');
            usersListElement.innerHTML = '';
            
            // ì‚¬ìš©ìž ëª©ë¡ì´ ë¹„ì–´ìžˆëŠ” ê²½ìš°
            if (Object.keys(onlineUsers).length === 0) {
                usersListElement.innerHTML = '<div style="padding: 5px 0; color: #888;">ì‚¬ìš©ìžê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            // ê° ì‚¬ìš©ìžë¥¼ ëª©ë¡ì— ì¶”ê°€
            for (const userId in onlineUsers) {
                const user = onlineUsers[userId];
                const userElement = document.createElement('div');
                userElement.classList.add('user-item');
                
                // ì‚¬ìš©ìž ì •ë³´ ë¶€ë¶„
                const userInfoElement = document.createElement('div');
                userInfoElement.classList.add('user-info');
                userInfoElement.innerHTML = `
                    <div class="user-color" style="background-color: ${user.color}"></div>
                    <div>
                        ${user.username}${user.id === socket.id ? ' (ë‚˜)' : ''}
                        ${user.isAdmin ? '<span class="admin-badge">ê´€ë¦¬ìž</span>' : ''}
                        ${user.isSuspended ? '<span class="suspended-badge">ì •ì§€ë¨</span>' : ''}
                    </div>
                `;
                
                userElement.appendChild(userInfoElement);
                
                // ê´€ë¦¬ìž ê¶Œí•œì´ ìžˆê³ , ìžê¸° ìžì‹ ì´ ì•„ë‹ˆë©´ ì œìž¬ ë²„íŠ¼ í‘œì‹œ
                if (isAdmin && user.id !== socket.id) {
                    const adminControlsElement = document.createElement('div');
                    adminControlsElement.classList.add('admin-controls');
                    adminControlsElement.innerHTML = `
                        <button data-username="${user.username}" data-duration="5">5ì´ˆ</button>
                        <button data-username="${user.username}" data-duration="10">10ì´ˆ</button>
                        <button data-username="${user.username}" data-duration="20">20ì´ˆ</button>
                        <button data-username="${user.username}" data-duration="60">1ë¶„</button>
                        <button class="kick-button" data-username="${user.username}">ê°•í‡´</button>
                    `;
                    
                    // ì •ì§€ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    adminControlsElement.querySelectorAll('button:not(.kick-button)').forEach(button => {
                        button.addEventListener('click', function() {
                            const targetUsername = this.getAttribute('data-username');
                            const duration = parseInt(this.getAttribute('data-duration'));
                            
                            socket.emit('suspendUser', {
                                targetUsername: targetUsername,
                                duration: duration
                            });
                        });
                    });
                    
                    // ê°•í‡´ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    adminControlsElement.querySelector('.kick-button').addEventListener('click', function() {
                        const targetUsername = this.getAttribute('data-username');
                        
                        if (confirm(`${targetUsername}ë‹˜ì„ ê°•í‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                            socket.emit('kickUser', {
                                targetUsername: targetUsername
                            });
                        }
                    });
                    
                    userElement.appendChild(adminControlsElement);
                }
                
                usersListElement.appendChild(userElement);
            }
        }
        
        // ì‚¬ìš©ìž ëª©ë¡ í† ê¸€ ê¸°ëŠ¥
        document.getElementById('users-toggle').addEventListener('click', () => {
            const usersPanel = document.getElementById('users-panel');
            const toggleIcon = document.querySelector('.toggle-icon');
            
            usersPanel.classList.toggle('active');
            toggleIcon.classList.toggle('active');
        });
        
        // ì‚¬ìš©ìž ì´ë¦„ ì„¤ì •
        document.getElementById('username-submit').addEventListener('click', () => {
            const usernameInput = document.getElementById('username-input');
            username = usernameInput.value.trim();
            
            if (username) {
                userColor = getRandomColor();
                document.getElementById('username-modal').style.display = 'none';
                
                // ê´€ë¦¬ìž ì—¬ë¶€ í™•ì¸
                isAdmin = (username === ADMIN_USERNAME);
                
                // ì„œë²„ì— ì‚¬ìš©ìž ì •ë³´ ì „ì†¡
                socket.emit('join', {
                    username: username,
                    color: userColor,
                    isAdmin: isAdmin
                });
                
                // ê´€ë¦¬ìž ì•ˆë‚´ ë©”ì‹œì§€
                if (isAdmin) {
                    addMessage('ê´€ë¦¬ìžë¡œ ë¡œê·¸ì¸í–ˆìŠµë‹ˆë‹¤. /ì •ì§€ [ì‚¬ìš©ìžì´ë¦„] [ì´ˆ], /ê°•í‡´ [ì‚¬ìš©ìžì´ë¦„] ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.', false, false, true);
                }
            }
        });
        
        // ì—”í„°í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // ì „ì†¡ ë²„íŠ¼ í´ë¦­
        document.getElementById('send-button').addEventListener('click', sendMessage);
        
        // ì†Œì¼“ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        socket.on('userJoined', (data) => {
            addMessage(`${data.username}ë‹˜ì´ ì±„íŒ…ë°©ì— ìž…ìž¥í•˜ì…¨ìŠµë‹ˆë‹¤.`, false, true);
            document.getElementById('user-count').textContent = data.userCount;
            
            // ìƒˆ ì‚¬ìš©ìž ì •ë³´ ì €ìž¥
            onlineUsers[data.id] = {
                id: data.id,
                username: data.username,
                color: data.color,
                isAdmin: data.isAdmin,
                isSuspended: false
            };
            
            // ì‚¬ìš©ìž ëª©ë¡ ì—…ë°ì´íŠ¸
            updateOnlineUsersList();
        });
        
        socket.on('userLeft', (data) => {
            addMessage(`${data.username}ë‹˜ì´ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì…¨ìŠµë‹ˆë‹¤.`, false, true);
            document.getElementById('user-count').textContent = data.userCount;
            
            // ì‚¬ìš©ìž ì œê±°
            for (const userId in onlineUsers) {
                if (onlineUsers[userId].username === data.username) {
                    delete onlineUsers[userId];
                    break;
                }
            }
            
            // ì‚¬ìš©ìž ëª©ë¡ ì—…ë°ì´íŠ¸
            updateOnlineUsersList();
        });
        
        socket.on('newMessage', (data) => {
            const isMyMessage = data.sender === username;
            
            // ë©˜ì…˜ í™•ì¸ ë° ì•Œë¦¼ í‘œì‹œ
            if (!isMyMessage && data.mentions && data.mentions.includes(username)) {
                showMentionAlert(data.sender);
            }
            
            if (isMyMessage) {
                addMessage(data.text, true);
            } else {
                const messageWithSender = `<strong style="color: ${data.color}">${data.sender}</strong>: ${data.text}
                <div class="message-info">${formatTime(data.timestamp)}</div>`;
                addMessage(messageWithSender, false);
            }
        });
        
        socket.on('updateUserCount', (data) => {
            document.getElementById('user-count').textContent = data.userCount;
        });
        
        // ì„œë²„ë¡œë¶€í„° í˜„ìž¬ í™œì„± ì‚¬ìš©ìž ëª©ë¡ ìš”ì²­
        socket.on('connect', () => {
            socket.emit('getActiveUsers');
        });
        
        // í˜„ìž¬ í™œì„± ì‚¬ìš©ìž ëª©ë¡ ìˆ˜ì‹ 
        socket.on('activeUsers', (users) => {
            for (const userId in users) {
                onlineUsers[userId] = {
                    id: userId,
                    username: users[userId].username,
                    color: users[userId].color,
                    isAdmin: users[userId].isAdmin,
                    isSuspended: users[userId].isSuspended
                };
            }
            updateOnlineUsersList();
        });
        
        // ì‚¬ìš©ìž ì •ì§€ ì²˜ë¦¬
        socket.on('userSuspended', (data) => {
            // ë‚˜ë¥¼ ì •ì§€í•œ ê²½ìš°
            if (data.username === username) {
                isSuspended = true;
                suspendedUntil = Date.now() + (data.duration * 1000);
                
                // ì´ì „ íƒ€ì´ë¨¸ê°€ ìžˆìœ¼ë©´ ì œê±°
                if (suspendTimer) {
                    clearTimeout(suspendTimer);
                }
                
                // ì •ì§€ í•´ì œ íƒ€ì´ë¨¸ ì„¤ì •
                suspendTimer = setTimeout(() => {
                    isSuspended = false;
                    suspendedUntil = null;
                    addMessage(`ì±„íŒ… ì •ì§€ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, false, true);
                }, data.duration * 1000);
                
                addMessage(`${data.adminUsername}ë‹˜ì´ íšŒì›ë‹˜ì„ ${data.duration}ì´ˆ ë™ì•ˆ ì±„íŒ… ì •ì§€í–ˆìŠµë‹ˆë‹¤.`, false, false, true);
            }
            
            // ì •ì§€ëœ ì‚¬ìš©ìž ìƒíƒœ ì—…ë°ì´íŠ¸
            for (const userId in onlineUsers) {
                if (onlineUsers[userId].username === data.username) {
                    onlineUsers[userId].isSuspended = true;
                    break;
                }
            }
            
            // ì •ì§€ ë©”ì‹œì§€ í‘œì‹œ
            addMessage(`${data.adminUsername}ë‹˜ì´ ${data.username}ë‹˜ì„ ${data.duration}ì´ˆ ë™ì•ˆ ì±„íŒ… ì •ì§€í–ˆìŠµë‹ˆë‹¤.`, false, false, true);
            
            // ì‚¬ìš©ìž ëª©ë¡ ì—…ë°ì´íŠ¸
            updateOnlineUsersList();
            
            // ì§€ì •ëœ ì‹œê°„ í›„ ì •ì§€ ìƒíƒœ í•´ì œ
            setTimeout(() => {
                for (const userId in onlineUsers) {
                    if (onlineUsers[userId].username === data.username) {
                        onlineUsers[userId].isSuspended = false;
                        break;
                    }
                }
                
                // ì‚¬ìš©ìž ëª©ë¡ ì—…ë°ì´íŠ¸
                updateOnlineUsersList();
            }, data.duration * 1000);
        });
        
        // ê°•í‡´ ì²˜ë¦¬
        socket.on('userKicked', (data) => {
            // ê°•í‡´ ë©”ì‹œì§€ í‘œì‹œ
            addMessage(`${data.adminUsername}ë‹˜ì´ ${data.username}ë‹˜ì„ ê°•í‡´í–ˆìŠµë‹ˆë‹¤.`, false, false, false, true);
            
            // ê°•í‡´ëœ ì‚¬ìš©ìžë¥¼ ì˜¨ë¼ì¸ ëª©ë¡ì—ì„œ ì œê±°
            for (const userId in onlineUsers) {
                if (onlineUsers[userId].username === data.username) {
                    delete onlineUsers[userId];
                    break;
                }
            }
            
            // ì‚¬ìš©ìž ëª©ë¡ ì—…ë°ì´íŠ¸
            updateOnlineUsersList();
        });
        
        // ê°•í‡´ë‹¹í•œ ì‚¬ìš©ìž ì²˜ë¦¬
        socket.on('kicked', (data) => {
            showKickAlert(data.adminUsername);
            addMessage(`${data.adminUsername}ë‹˜ì— ì˜í•´ ê°•í‡´ë˜ì—ˆìŠµë‹ˆë‹¤. ì—°ê²°ì´ ì¢…ë£Œë©ë‹ˆë‹¤.`, false, false, false, true);
            
            // ë©”ì‹œì§€ ìž…ë ¥ ë¹„í™œì„±í™”
            document.getElementById('message-input').disabled = true;
            document.getElementById('send-button').disabled = true;
        });
        
        // íƒ€ì´í•‘ ê¸°ëŠ¥
        let typingTimeout;
        document.getElementById('message-input').addEventListener('input', () => {
            // ì •ì§€ ìƒíƒœì—ì„œëŠ” íƒ€ì´í•‘ ì´ë²¤íŠ¸ ë°œìƒí•˜ì§€ ì•ŠìŒ
            if (!isSuspended) {
                socket.emit('typing');
                
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    socket.emit('stopTyping');
                }, 1000);
            }
        });
        
        // ë‹¤ë¥¸ ì‚¬ìš©ìž íƒ€ì´í•‘ í‘œì‹œ
socket.on('userTyping', (data) => {
    const typingIndicator = document.getElementById('typing-indicator');
    typingIndicator.innerHTML = `
        ${data.username}ë‹˜ì´ ìž…ë ¥ ì¤‘
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    typingIndicator.style.display = 'flex';
});
        
        // ì‚¬ìš©ìž ì´ë¦„ ìž…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
        window.onload = () => {
            document.getElementById('username-input').focus();
        };
        
        // ì—”í„°í‚¤ë¡œ ì‚¬ìš©ìž ì´ë¦„ ì œì¶œ
        document.getElementById('username-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('username-submit').click();
            }
        });
        
        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ - ì—°ê²° ì„±ê³µ
        socket.on('connect', () => {
            addMessage('ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìž ì´ë¦„ì„ ìž…ë ¥í•˜ì„¸ìš”.', false, true);
        });
        
        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ - ì—°ê²° ëŠê¹€
        socket.on('disconnect', () => {
            addMessage('ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ìž¬ì—°ê²° ì¤‘...', false, true);
        });
        
        // ì‚¬ìš©ìž ì´ë¦„ ì˜¤ë¥˜ ì²˜ë¦¬
        socket.on('joinError', (data) => {
            alert(data.message);
            document.getElementById('username-modal').style.display = 'flex';
            document.getElementById('username-input').focus();
        });
    </script>
</body>
</html>
